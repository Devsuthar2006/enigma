<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Join Session ‚Äî DebAItor</title>
  <meta name="description" content="Join a live discussion session on DebAItor.">
  <link rel="stylesheet" href="styles.css">
  <style>
    /* ‚îÄ‚îÄ Join page enterprise overrides ‚îÄ‚îÄ */

    /* Setup / Join Form */
    .join-wrapper {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 2rem;
      background: var(--bg-dark);
    }
    .join-card {
      width: 100%;
      max-width: 380px;
    }
    .join-card .brand {
      font-size: 0.82rem;
      font-weight: 700;
      color: #6b7280;
      letter-spacing: -0.01em;
      margin-bottom: 2.5rem;
    }
    .join-card .brand span { color: var(--accent); }
    .join-card h1 {
      font-size: 1.5rem;
      color: #fff;
      margin-bottom: 0.35rem;
    }
    .join-card .subtitle {
      font-size: 0.82rem;
      color: #6b7280;
      margin-bottom: 2rem;
    }
    .join-card .field {
      margin-bottom: 1.25rem;
    }
    .join-card label {
      font-size: 0.75rem;
      font-weight: 600;
      color: #9ca3af;
      display: block;
      margin-bottom: 0.35rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .join-card input[type="text"] {
      background: #1f2937;
      border: 1px solid #374151;
      color: #fff;
      padding: 0.75rem 0.85rem;
      font-size: 0.95rem;
      border-radius: 6px;
    }
    .join-card input[type="text"]:focus {
      border-color: #6b7280;
    }
    .join-card input[type="text"]::placeholder {
      color: #4b5563;
    }
    .join-card .code-input {
      font-family: 'SF Mono', 'Fira Code', monospace;
      font-size: 1.25rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
    }
    .join-card .btn-join {
      width: 100%;
      padding: 0.8rem;
      background: #fff;
      color: #111827;
      font-size: 0.88rem;
      font-weight: 600;
      font-family: var(--font-stack);
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.15s;
      margin-top: 0.5rem;
    }
    .join-card .btn-join:hover { background: #f3f4f6; }
    .join-card .back-link {
      display: block;
      text-align: center;
      margin-top: 1.5rem;
      font-size: 0.78rem;
      color: #6b7280;
      text-decoration: none;
    }
    .join-card .back-link:hover { color: #fff; }

    /* ‚îÄ‚îÄ Active debate interface ‚îÄ‚îÄ */
    .debate-wrapper {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background: var(--bg-dark);
      color: #fff;
      padding: 1.5rem;
    }
    .debate-topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 1rem;
      border-bottom: 1px solid #1f2937;
    }
    .debate-topbar .topic {
      font-size: 0.88rem;
      font-weight: 600;
      color: #d1d5db;
    }
    .debate-topbar .status-pill {
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      padding: 0.25rem 0.65rem;
      border-radius: 50px;
      background: #1f2937;
      color: #6b7280;
    }
    .debate-topbar .status-pill.active {
      background: rgba(37, 99, 235, 0.15);
      color: #60a5fa;
    }

    .debate-center {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 2rem 0;
    }
    .mic-btn {
      width: 110px;
      height: 110px;
      border-radius: 50%;
      background: #1f2937;
      border: 2px solid #374151;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .mic-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
    .mic-btn:not(:disabled):hover {
      border-color: #6b7280;
    }
    .mic-btn svg {
      width: 28px;
      height: 28px;
      fill: #9ca3af;
    }
    .mic-btn.recording {
      background: var(--accent);
      border-color: var(--accent);
      animation: pulse-ring 1.5s infinite;
    }
    .mic-btn.recording svg { fill: #fff; }

    .timer-text {
      font-size: 2.5rem;
      font-weight: 700;
      margin-top: 1.25rem;
      font-feature-settings: "tnum";
      font-variant-numeric: tabular-nums;
      color: #fff;
    }
    .turn-instruction {
      font-size: 0.82rem;
      color: #6b7280;
      margin-top: 0.5rem;
    }

    /* Feedback bar */
    .feedback-bar {
      margin-top: auto;
      background: #1f2937;
      border: 1px solid #374151;
      border-radius: 8px;
      padding: 1rem 1.25rem;
    }
    .feedback-bar .fb-label {
      font-size: 0.68rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #6b7280;
      margin-bottom: 0.5rem;
    }
    .feedback-bar .fb-score {
      font-size: 1.5rem;
      font-weight: 700;
      color: #fff;
    }
    .feedback-bar .fb-insight {
      font-size: 0.82rem;
      color: #9ca3af;
      margin-top: 0.35rem;
    }

    /* ‚îÄ‚îÄ Results view ‚îÄ‚îÄ */
    .results-wrapper {
      min-height: 100vh;
      background: var(--bg-light);
      padding: 2rem;
    }
    .results-inner {
      max-width: 640px;
      margin: 0 auto;
    }
    .results-head {
      text-align: center;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid var(--border);
      margin-bottom: 2rem;
    }
    .results-head h1 {
      font-size: 1.5rem;
      color: var(--text-primary);
      margin-bottom: 0.3rem;
    }
    .results-head p {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .topic-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      background: var(--bg-subtle);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.6rem 1rem;
      margin-bottom: 1.5rem;
      width: 100%;
    }
    .topic-pill .tp-label {
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .topic-pill .tp-text {
      font-size: 0.88rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    /* Participant result card */
    .p-card {
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1.25rem;
      margin-bottom: 0.75rem;
      transition: border-color 0.15s;
    }
    .p-card.is-winner { border-color: var(--text-primary); }
    .p-card.is-you { border-left: 3px solid var(--accent); }
    .p-card-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    .p-card-rank {
      font-size: 0.85rem;
      font-weight: 700;
      color: var(--text-muted);
      min-width: 28px;
    }
    .p-card-name {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--text-primary);
      flex: 1;
      margin-left: 0.75rem;
    }
    .p-card-badge {
      font-size: 0.65rem;
      font-weight: 700;
      padding: 0.15rem 0.5rem;
      border-radius: 4px;
      margin-left: 0.5rem;
    }
    .p-card-badge.you {
      background: rgba(37, 99, 235, 0.1);
      color: var(--accent);
    }
    .p-card-badge.winner {
      background: var(--bg-dark);
      color: #fff;
    }
    .p-card-score {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    /* Metrics row */
    .p-metrics {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.5rem;
    }
    .p-metric {
      text-align: center;
      padding: 0.5rem;
      background: var(--bg-subtle);
      border-radius: 6px;
    }
    .p-metric .m-label {
      display: block;
      font-size: 0.65rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }
    .p-metric .m-value {
      display: block;
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-top: 0.2rem;
    }

    /* Responses expandable */
    .p-responses {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border);
    }
    .p-responses h4 {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-bottom: 0.65rem;
    }
    .p-response {
      padding: 0.65rem 0.85rem;
      background: var(--bg-subtle);
      border-left: 2px solid var(--border-strong);
      border-radius: 0 6px 6px 0;
      margin-bottom: 0.5rem;
    }
    .p-response-head {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.3rem;
    }
    .p-response-head .round {
      font-size: 0.78rem;
      font-weight: 600;
      color: var(--text-primary);
    }
    .p-response-head .score {
      font-size: 0.78rem;
      font-weight: 700;
      color: var(--text-primary);
    }
    .p-response .insight {
      font-size: 0.78rem;
      color: var(--text-secondary);
      font-style: italic;
    }
    .p-response .transcript {
      font-size: 0.72rem;
      color: var(--text-muted);
      margin-top: 0.3rem;
      padding-top: 0.3rem;
      border-top: 1px solid var(--border);
    }

    .results-back {
      display: block;
      width: 100%;
      padding: 0.75rem;
      background: var(--bg-dark);
      color: #fff;
      border: none;
      border-radius: 6px;
      text-align: center;
      text-decoration: none;
      font-size: 0.88rem;
      font-weight: 600;
      font-family: var(--font-stack);
      cursor: pointer;
      margin-top: 1.5rem;
      transition: background 0.15s;
    }
    .results-back:hover { background: #000; }

    /* ‚îÄ‚îÄ Mode-specific themes ‚îÄ‚îÄ */
    .debate-wrapper {
      --mode-accent: #2563eb;
      --mode-accent-glow: rgba(37, 99, 235, 0.15);
      --mode-bg: #111827;
      --mode-surface: #1f2937;
      --mode-border: #374151;
    }
    .debate-wrapper.mode-classroom {
      --mode-accent: #059669;
      --mode-accent-glow: rgba(5, 150, 105, 0.15);
      --mode-bg: #0f1f17;
      --mode-surface: #132a1e;
      --mode-border: #1e4030;
    }
    .debate-wrapper.mode-panel {
      --mode-accent: #7c3aed;
      --mode-accent-glow: rgba(124, 58, 237, 0.15);
      --mode-bg: #1a1225;
      --mode-surface: #231a30;
      --mode-border: #362d45;
    }
    .debate-wrapper.mode-meeting {
      --mode-accent: #d97706;
      --mode-accent-glow: rgba(217, 119, 6, 0.15);
      --mode-bg: #1a1508;
      --mode-surface: #2a2010;
      --mode-border: #45371e;
    }

    /* Apply mode colors */
    .debate-wrapper {
      background: var(--mode-bg);
    }
    .debate-topbar {
      border-bottom-color: var(--mode-border);
    }
    .debate-topbar .status-pill.active {
      background: var(--mode-accent-glow);
      color: var(--mode-accent);
    }
    .mic-btn {
      background: var(--mode-surface);
      border-color: var(--mode-border);
    }
    .mic-btn:not(:disabled):hover {
      border-color: var(--mode-accent);
    }
    .mic-btn.recording {
      background: var(--mode-accent);
      border-color: var(--mode-accent);
    }
    .feedback-bar {
      background: var(--mode-surface);
      border-color: var(--mode-border);
    }

    /* Mode banner */
    .mode-banner {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.5rem;
      background: var(--mode-accent-glow);
      border-bottom: 1px solid var(--mode-border);
      font-size: 0.72rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--mode-accent);
    }
    .mode-banner .mode-icon-lg {
      font-size: 0.9rem;
    }

    /* Responsive */
    @media (max-width: 480px) {
      .join-wrapper { padding: 1.25rem; }
      .debate-wrapper { padding: 1rem; }
      .results-wrapper { padding: 1rem; }
      .p-metrics { grid-template-columns: repeat(2, 1fr); }
      .mic-btn { width: 90px; height: 90px; }
      .mic-btn svg { width: 24px; height: 24px; }
      .timer-text { font-size: 2rem; }

      /* Additional mobile styles */
      .brand { font-size: 1.25rem; }
      .join-card { padding: 1.5rem; }
      .mic-btn { width: 72px; height: 72px; }
      .mic-btn svg { width: 24px; height: 24px; }
      .timer-text { font-size: 2rem; }
    }
    
    /* Add a clean export look for Brag Cards */
    .brag-export {
      padding: 20px !important;
      background: linear-gradient(135deg, #111827 0%, #1f2937 100%) !important;
      border-radius: 12px;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body class="mobile-dark" style="padding: 0; display: block;">
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <!-- ‚ïê‚ïê‚ïê JOIN FORM ‚ïê‚ïê‚ïê -->
  <div id="join-form" class="join-wrapper">
    <div class="join-card">
      <div class="brand">DEBAITOR<span>.</span></div>
      <h1>Join Session</h1>
      <p class="subtitle">Enter the room code shared by your host.</p>

      <div class="field">
        <label for="code-input">Room Code</label>
        <input type="text" id="code-input" class="code-input hidden" placeholder="ABC123" maxlength="6" autocomplete="off">
      </div>
      <div class="field">
        <label for="name">Your Name</label>
        <input type="text" id="name" placeholder="Enter your name" autocomplete="off">
      </div>
      <button class="btn-join" onclick="joinRoom()">Join Session</button>
      <a href="/" class="back-link">‚Üê Back to home</a>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê ACTIVE SESSION (Mode-aware) ‚ïê‚ïê‚ïê -->
  <div id="debate-interface" class="hidden debate-wrapper">
    <!-- Mode banner ‚Äî visually changes per mode -->
    <div class="mode-banner" id="mode-banner">
      <span class="mode-icon-lg" id="mode-icon">‚öîÔ∏è</span>
      <span id="mode-banner-text">DEBATE MODE</span>
    </div>

    <div class="debate-topbar">
      <div>
        <span class="topic" id="topic-display">Topic</span>
      </div>
      <span class="status-pill" id="status-text">STANDBY</span>
    </div>

    <div class="debate-center">
      <div style="position: relative; width: 100%; display: flex; flex-direction: column; align-items: center;">
        <canvas id="waveform" width="200" height="60" style="display: none; margin-bottom: 20px; border-radius: 8px;"></canvas>
        <button id="record-btn" class="mic-btn" disabled>
          <svg viewBox="0 0 24 24">
            <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
            <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
          </svg>
        </button>
      </div>
      <div id="timer" class="timer-text">00:30</div>
      <p id="instruction" class="turn-instruction">Wait for your turn</p>
      <button id="hand-btn" class="btn" style="display: none; margin-top: 15px; border-radius: 20px; font-weight: bold; padding: 10px 20px; background-color: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2);" onclick="toggleHand()">‚úã Raise Hand</button>
    </div>

    <div class="feedback-bar" id="feedback-area">
      <div class="fb-label" id="fb-label-text">AI Analysis</div>
      <div class="fb-score" id="latest-score">‚Äî</div>
      <div class="fb-insight" id="latest-insight">Scores will appear here after your turn.</div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê RESULTS ‚ïê‚ïê‚ïê -->
  <div id="ended-interface" class="hidden results-wrapper">
    <div class="results-inner">
      <div class="results-head">
        <h1>Session Results</h1>
        <p>Final scores and feedback for all participants.</p>
      </div>

      <div class="topic-pill">
        <span class="tp-label">Topic</span>
        <span class="tp-text" id="results-topic">Loading...</span>
      </div>

      <div id="results-list"></div>

      <a href="/" class="results-back">‚Üê Back to Home</a>
    </div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    let roomCode = urlParams.get('code');
    let participantId = null;
    let isRecording = false;
    let mediaRecorder = null;
    let audioChunks = [];
    let pollInterval;
    let lastScore = null;
    let currentMode = 'debate';
    let currentTimeLimit = 30;
    let handRaised = false;
    
    // Waveform visualization context
    let audioCtx, analyser, dataArray, bufferLength, canvas, canvasCtx, drawVisual;

    // Mode-specific configuration
    const MODE_CONFIG = {
      debate: {
        icon: '‚öîÔ∏è',
        label: 'Debate Mode',
        joinBtn: 'Enter Arena',
        waitMsg: 'Wait for your turn to argue',
        turnMsg: 'Present your argument',
        recordMsg: 'Recording argument...',
        fbLabel: 'AI Score',
        fbWait: 'Your score will appear after your argument.',
        resultsTitle: 'Debate Results',
        resultsSub: 'Final rankings based on argument quality.',
        topbarColor: '#2563eb'
      },
      classroom: {
        icon: 'üìö',
        label: 'Classroom Mode',
        joinBtn: 'Join Classroom',
        waitMsg: 'Listen and prepare your thoughts',
        turnMsg: 'Share your understanding',
        recordMsg: 'Recording response...',
        fbLabel: 'Learning Feedback',
        fbWait: 'Feedback on your understanding will appear here.',
        resultsTitle: 'Learning Summary',
        resultsSub: 'Individual feedback and skill assessment.',
        topbarColor: '#059669'
      },
      panel: {
        icon: 'üéôÔ∏è',
        label: 'Panel Discussion',
        joinBtn: 'Join Panel',
        waitMsg: 'Waiting for your turn to contribute',
        turnMsg: 'Share your perspective',
        recordMsg: 'Recording contribution...',
        fbLabel: 'Contribution Score',
        fbWait: 'Your contribution analysis will appear here.',
        resultsTitle: 'Panel Analysis',
        resultsSub: 'Participation balance and contribution quality.',
        topbarColor: '#7c3aed'
      },
      meeting: {
        icon: 'üíº',
        label: 'Meeting Mode',
        joinBtn: 'Join Meeting',
        waitMsg: 'Listening to current speaker',
        turnMsg: 'Present your point',
        recordMsg: 'Recording input...',
        fbLabel: 'Input Analysis',
        fbWait: 'Analysis of your contribution will appear here.',
        resultsTitle: 'Meeting Summary',
        resultsSub: 'Key takeaways and participation overview.',
        topbarColor: '#d97706'
      }
    };

    function applyModeUI(mode) {
      currentMode = mode || 'debate';
      const cfg = MODE_CONFIG[currentMode] || MODE_CONFIG.debate;
      const wrapper = document.getElementById('debate-interface');

      // Remove old mode classes, add new one
      wrapper.classList.remove('mode-debate', 'mode-classroom', 'mode-panel', 'mode-meeting');
      wrapper.classList.add(`mode-${currentMode}`);

      // Update mode banner (the most visible differentiator)
      document.getElementById('mode-icon').textContent = cfg.icon;
      document.getElementById('mode-banner-text').textContent = cfg.label.toUpperCase();

      // Feedback area
      document.getElementById('fb-label-text').textContent = cfg.fbLabel;
      document.getElementById('latest-insight').textContent = cfg.fbWait;

      // Instruction text
      document.getElementById('instruction').textContent = cfg.waitMsg;

      // Store in session
      sessionStorage.setItem('sessionMode', currentMode);
    }

    // Show code input if no code in URL
    if (!roomCode) {
      document.getElementById('code-input').classList.remove('hidden');
    }

    async function toggleHand() {
      handRaised = !handRaised;
      const hb = document.getElementById('hand-btn');
      hb.textContent = handRaised ? '‚è¨ Lower Hand' : '‚úã Raise Hand';
      hb.style.background = handRaised ? 'rgba(217,119,6,0.5)' : 'rgba(255,255,255,0.1)';

      const endpoint = handRaised ? 'raise-hand' : 'lower-hand';
      try {
        await fetch(`/api/rooms/${roomCode}/${endpoint}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ participantId })
        });
      } catch (err) {
        console.error('Failed to toggle hand', err);
      }
    }

    async function joinRoom() {
      if (!roomCode) {
        roomCode = document.getElementById('code-input').value.toUpperCase();
      }
      const name = document.getElementById('name').value;
      if (!roomCode) return alert('Room code required');
      if (!name) return alert('Name required');

      try {
        const res = await fetch(`/api/rooms/${roomCode}/join`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name })
        });
        const data = await res.json();
        if (data.error) throw new Error(data.error);

        participantId = data.participantId;
        sessionStorage.setItem('participantId', participantId);
        sessionStorage.setItem('roomCode', roomCode);
        sessionStorage.setItem('participantName', name);

        document.getElementById('join-form').classList.add('hidden');
        document.getElementById('debate-interface').classList.remove('hidden');
        document.getElementById('debate-interface').style.display = 'flex';
        document.getElementById('topic-display').textContent = data.topic;
        
        // Apply mode-specific UI
        applyModeUI(data.mode);

        await initAudio();
        pollInterval = setInterval(checkStatus, 2000);
        checkStatus();
      } catch (e) {
        alert(e.message);
      }
    }

    // Restore session on page load
    window.onload = async function() {
      const savedParticipantId = sessionStorage.getItem('participantId');
      const savedRoomCode = sessionStorage.getItem('roomCode');
      if (!roomCode && savedRoomCode) roomCode = savedRoomCode;

      if (savedParticipantId && roomCode) {
        try {
          const res = await fetch(`/api/rooms/${roomCode}`);
          if (!res.ok) {
            sessionStorage.removeItem('participantId');
            sessionStorage.removeItem('roomCode');
            sessionStorage.removeItem('participantName');
            return;
          }
          const data = await res.json();
          const isStillInRoom = data.participants.some(p => p.id === savedParticipantId);

          if (isStillInRoom) {
            participantId = savedParticipantId;
            document.getElementById('join-form').classList.add('hidden');
            document.getElementById('debate-interface').classList.remove('hidden');
            document.getElementById('debate-interface').style.display = 'flex';
            document.getElementById('topic-display').textContent = data.topic;
            
            // Apply mode UI from server data or session
            applyModeUI(data.mode || sessionStorage.getItem('sessionMode'));

            if (data.status === 'results' || data.status === 'evaluating') {
              showEndedScreen();
              return;
            }
            await initAudio();
            pollInterval = setInterval(checkStatus, 2000);
            checkStatus();
          } else {
            sessionStorage.removeItem('participantId');
            sessionStorage.removeItem('roomCode');
            sessionStorage.removeItem('participantName');
          }
        } catch (error) {
          console.error('Failed to restore session:', error);
        }
      }
    };

    async function initAudio() {
      try {
        // Enhanced audio constraints for better voice capture
        const stream = await navigator.mediaDevices.getUserMedia({
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: true,
            sampleRate: 16000,
            channelCount: 1
          }
        });
        
        // Prefer webm/opus for best Whisper compatibility
        const mimeType = MediaRecorder.isTypeSupported('audio/webm;codecs=opus')
          ? 'audio/webm;codecs=opus'
          : MediaRecorder.isTypeSupported('audio/webm')
            ? 'audio/webm'
            : undefined;
        
        mediaRecorder = new MediaRecorder(stream, mimeType ? { mimeType } : {});
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = uploadAudio;
      } catch (e) {
        alert('Microphone access denied. You cannot participate.');
      }
    }

    let lastTurnStatus = null;

    async function checkStatus() {
      try {
        const res = await fetch(`/api/rooms/${roomCode}/turn-status?participantId=${participantId}`);
        if (!res.ok) return; // Don't touch UI on failed request
        
        const data = await res.json();
        if (data.error) return;

        if (data.status === 'results' || data.status === 'evaluating') {
          clearInterval(pollInterval);
          showEndedScreen();
          return;
        }

        // Skip DOM update if nothing changed
        const fingerprint = `${data.isMyTurn}-${data.currentTurnName}-${data.status}-${data.timeLimit}`;
        if (fingerprint === lastTurnStatus) return;
        lastTurnStatus = fingerprint;

        if (data.timeLimit) currentTimeLimit = parseInt(data.timeLimit);

        const btn = document.getElementById('record-btn');
        const status = document.getElementById('status-text');
        const instruction = document.getElementById('instruction');
        const cfg = MODE_CONFIG[currentMode] || MODE_CONFIG.debate;

        const handBtn = document.getElementById('hand-btn');

        if (data.isMyTurn && !isRecording) {
          handBtn.style.display = 'none'; // Clear hand btn
          btn.disabled = false;
          status.textContent = 'YOUR TURN';
          status.classList.add('active');
          instruction.textContent = cfg.turnMsg;
          btn.onclick = () => {
             if (!isRecording) startRecording();
             else stopRecording();
          };
        } else if (!data.isMyTurn) {
          btn.disabled = true;
          status.textContent = data.currentTurnName ? `${data.currentTurnName}'S TURN` : 'WAITING';
          status.classList.remove('active');
          instruction.textContent = cfg.waitMsg;
          
          if (data.status === 'collecting') {
            handBtn.style.display = 'block';
          } else {
            handBtn.style.display = 'none';
          }
        }
      } catch (e) {
        // Network error ‚Äî don't touch UI, just wait for next poll
        console.warn('Status check error (will retry):', e.message);
      }
    }

    async function showEndedScreen() {
      document.getElementById('debate-interface').style.display = 'none';
      document.getElementById('ended-interface').classList.remove('hidden');
      document.getElementById('ended-interface').style.display = 'block';
      document.body.style.background = '#fff';
      document.body.classList.remove('mobile-dark');

      try {
        const res = await fetch(`/api/rooms/${roomCode}/results`);
        const data = await res.json();
        if (data.error) return;

        // Apply mode from results
        const mode = data.mode || currentMode;
        const cfg = MODE_CONFIG[mode] || MODE_CONFIG.debate;

        // Set mode-specific results header
        document.querySelector('.results-head h1').textContent = cfg.resultsTitle;
        document.querySelector('.results-head p').textContent = cfg.resultsSub;

        document.getElementById('results-topic').textContent = data.topic || 'Discussion';
        const resultsList = document.getElementById('results-list');
        resultsList.innerHTML = '';
        
        // Trigger Confetti effect
        const duration = 3 * 1000;
        const animationEnd = Date.now() + duration;
        const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };

        function randomInRange(min, max) {
          return Math.random() * (max - min) + min;
        }

        const interval = setInterval(function() {
          const timeLeft = animationEnd - Date.now();
          if (timeLeft <= 0) return clearInterval(interval);
          const particleCount = 50 * (timeLeft / duration);
          confetti({ ...defaults, particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } });
          confetti({ ...defaults, particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } });
        }, 250);

        data.results.forEach((p) => {
          const isWinner = p.rank === 1;
          const isYou = p.id === participantId;
          const scores = p.averageScores || {};

          let responsesHTML = '';
          if (p.responses && p.responses.length > 0) {
            responsesHTML = `
              <div class="p-responses">
                <h4>${p.responses.length} response(s)</h4>
                ${p.responses.map(r => `
                  <div class="p-response">
                    <div class="p-response-head">
                      <span class="round">Round ${r.round}</span>
                      <span class="score">${r.scores.finalScore}/10</span>
                    </div>
                    <div class="insight">${r.scores.summary || r.scores.insight || 'No feedback'}</div>
                    ${r.scores.roast ? `<div style="margin-top: 5px; font-style: italic; color: #f43f5e;">üî• ${r.scores.roast}</div>` : ''}
                    ${r.scores.factCheck ? `<div style="margin-top: 5px; font-size: 0.8rem; background: #f0fdf4; color: #166534; padding: 4px; border-radius: 4px; border: 1px solid #bbf7d0;">‚úì ${r.scores.factCheck}</div>` : ''}
                    ${r.transcript ? `<div class="transcript">"${r.transcript}"</div>` : ''}
                  </div>
                `).join('')}
              </div>
            `;
          }

          const card = document.createElement('div');
          card.className = `p-card ${isWinner ? 'is-winner' : ''} ${isYou ? 'is-you' : ''}`;
          card.innerHTML = `
            <div class="p-card-head">
              <div style="display:flex;align-items:center;">
                <span class="p-card-rank">#${p.rank}</span>
                <span class="p-card-name">
                  ${p.name}
                  ${isYou ? '<span class="p-card-badge you">YOU</span>' : ''}
                  ${isWinner ? '<span class="p-card-badge winner">WINNER</span>' : ''}
                </span>
              </div>
              <span class="p-card-score">${p.averageScore || '‚Äî'}</span>
            </div>
            <div class="p-metrics">
              <div class="p-metric"><span class="m-label">${mode === 'meeting' ? 'Substance' : 'Logic'}</span><span class="m-value">${scores.logic || 0}</span></div>
              <div class="p-metric"><span class="m-label">Clarity</span><span class="m-value">${scores.clarity || 0}</span></div>
              <div class="p-metric"><span class="m-label">Relevance</span><span class="m-value">${scores.relevance || 0}</span></div>
              <div class="p-metric"><span class="m-label">${mode === 'meeting' ? 'Focus' : 'Bias'}</span><span class="m-value">${scores.emotionalBias || 0}</span></div>
            </div>
            ${responsesHTML}
            ${isYou ? `<button onclick="exportBragCard(this.parentElement)" class="btn" style="width: 100%; margin-top: 15px; background: linear-gradient(45deg, #ec4899, #8b5cf6); color: white; font-weight: bold;">üì∏ Share Brag Card</button>` : ''}
          `;
          resultsList.appendChild(card);
        });
      } catch (e) {
        console.error('Error fetching results:', e);
      }
    }

    let timeLeft = 30;
    let timerInterval;

    function startRecording() {
      if (!mediaRecorder) return;
      audioChunks = [];
      mediaRecorder.start(100); // collect 100ms chunks
      isRecording = true;

      const btn = document.getElementById('record-btn');
      const instruction = document.getElementById('instruction');
      const cfg = MODE_CONFIG[currentMode] || MODE_CONFIG.debate;

      btn.classList.add('recording');
      instruction.textContent = cfg.recordMsg;

      // START WAVEFORM
      initWaveform();

      // Start timer
      let timeLeft = currentTimeLimit;
      document.getElementById('timer').textContent = `00:${timeLeft.toString().padStart(2, '0')}`;
      
      const timerInt = setInterval(() => {
        if (!isRecording) {
          clearInterval(timerInt);
          return;
        }
        timeLeft--;
        document.getElementById('timer').textContent = `00:${timeLeft.toString().padStart(2, '0')}`;
        
        if (timeLeft <= 0) {
          clearInterval(timerInt);
          stopRecording();
        }
      }, 1000);
    }

    function initWaveform() {
      const cvs = document.getElementById('waveform');
      cvs.style.display = 'block';
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioCtx.createAnalyser();
        const source = audioCtx.createMediaStreamSource(mediaRecorder.stream);
        source.connect(analyser);
        analyser.fftSize = 64;
        bufferLength = analyser.frequencyBinCount;
        dataArray = new Uint8Array(bufferLength);
        canvasCtx = cvs.getContext('2d');
      }
      
      drawVisual = requestAnimationFrame(drawWaveform);
    }

    function drawWaveform() {
      if (!isRecording) return;
      drawVisual = requestAnimationFrame(drawWaveform);
      analyser.getByteFrequencyData(dataArray);

      const cvs = document.getElementById('waveform');
      canvasCtx.clearRect(0, 0, cvs.width, cvs.height);

      const barWidth = (cvs.width / bufferLength) * 2.5;
      let barHeight;
      let x = 0;

      for (let i = 0; i < bufferLength; i++) {
        barHeight = dataArray[i] / 4;
        canvasCtx.fillStyle = 'rgba(255, 255, 255, 0.8)';
        canvasCtx.fillRect(x, cvs.height - barHeight, barWidth, barHeight);
        x += barWidth + 1;
      }
    }

    function stopRecording() {
      if (!isRecording) return;
      isRecording = false;
      mediaRecorder.stop();
      
      // Stop waveform
      if (drawVisual) cancelAnimationFrame(drawVisual);
      document.getElementById('waveform').style.display = 'none';
      
      clearInterval(timerInterval);
      document.getElementById('record-btn').classList.remove('recording');
      document.getElementById('record-btn').disabled = true;
      document.getElementById('instruction').textContent = 'Uploading response...';
    }

    async function uploadAudio() {
      const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
      const formData = new FormData();
      formData.append('audio', audioBlob, 'response.webm');
      formData.append('participantId', participantId);

      try {
        const res = await fetch(`/api/rooms/${roomCode}/submit`, {
          method: 'POST',
          body: formData
        });
        const data = await res.json();
        lastScore = data.scores.finalScore;
        document.getElementById('latest-score').textContent = data.scores.finalScore;
        
        // Show insight string with potential roast / fact check context
        let extraFeedback = [];
        if (data.scores.roast) extraFeedback.push(`üî• ${data.scores.roast}`);
        if (data.scores.factCheck) extraFeedback.push(`‚úì ${data.scores.factCheck}`);
        
        document.getElementById('latest-insight').innerHTML = `${data.scores.summary || data.scores.insight} <br/> <span style="font-size: 0.8rem; opacity: 0.8; margin-top:5px; display:block;">${extraFeedback.join('<br/>')}</span>`;
        document.getElementById('instruction').textContent = 'Response submitted!';
      } catch (e) {
        console.error(e);
        alert('Upload failed');
      }
    }

    async function exportBragCard(cardElement) {
      if (!window.html2canvas) {
        alert("Oops! Share tool is still loading. Try again in a second.");
        return;
      }
      
      const originalBtn = cardElement.querySelector('button');
      
      // Prepare card for export (remove button and add stylish wrapper class)
      if (originalBtn) originalBtn.style.display = 'none';
      cardElement.classList.add('brag-export');

      try {
        const canvas = await html2canvas(cardElement, {
          backgroundColor: '#111827',
          scale: 2 // High resolution
        });
        
        // Restore ui
        if (originalBtn) originalBtn.style.display = 'block';
        cardElement.classList.remove('brag-export');

        // Download
        const link = document.createElement('a');
        link.download = `DebAItor_BragCard_${new Date().getTime()}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
      } catch (err) {
        console.error("Failed to generate Brag Card", err);
        // Restore ui on fail
        if (originalBtn) originalBtn.style.display = 'block';
        cardElement.classList.remove('brag-export');
      }
    }
  </script>
</body>
</html>
